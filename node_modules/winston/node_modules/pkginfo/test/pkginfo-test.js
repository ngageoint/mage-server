/*
 * pkginfo-test.js: Tests for the pkginfo module.
 *
 * (C) 2011, Charlie Robbins
 *
 */

var ***REMOVED***ert = require('***REMOVED***ert'),
    exec = require('child_process').exec,
    fs = require('fs'),
    path = require('path'),
    vows = require('vows'),
    pkginfo = require('../lib/pkginfo');

function ***REMOVED***ertProperties (source, target) {
  ***REMOVED***ert.lengthOf(source, target.length + 1);
  target.forEach(function (prop) {
    ***REMOVED***ert.isTrue(!!~source.indexOf(prop));
  });
}

function compareWithExample(targetPath) {
  var examplePaths = ['package.json'];
  
  if (targetPath) {
    examplePaths.unshift(targetPath);
  }
  
  return function(exposed) {
    var pkg = fs.readFileSync(path.join.apply(null, [__dirname, '..', 'examples'].concat(examplePaths))).toString(),
        keys = Object.keys(JSON.parse(pkg));
    
    ***REMOVED***ertProperties(exposed, keys);
  };
}

function testExposes (options) {
  return {
    topic: function () {
      exec('node ' + path.join(__dirname, '..', 'examples', options.script), this.callback);
    },
    "should expose that property correctly": function (err, stdout, stderr) {
      ***REMOVED***ert.isNull(err);
      
      var exposed = stderr.match(/'(\w+)'/ig).map(function (p) { 
        return p.substring(1, p.length - 1);
      });
      
      return !options.***REMOVED***ert 
        ? ***REMOVED***ertProperties(exposed, options.properties)
        : options.***REMOVED***ert(exposed);
    }
  }
}

vows.describe('pkginfo').addBatch({
  "When using the pkginfo module": {
    "and p***REMOVED***ed a single `string` argument": testExposes({
      script: 'single-property.js',
      properties: ['version']
    }),
    "and p***REMOVED***ed multiple `string` arguments": testExposes({
      script: 'multiple-properties.js',
      properties: ['version', 'author']
    }),
    "and p***REMOVED***ed an `object` argument": testExposes({
      script: 'object-argument.js',
      properties: ['version', 'author']
    }),
    "and p***REMOVED***ed an `array` argument": testExposes({
      script: 'array-argument.js',
      properties: ['version', 'author']
    }),
    "and read from a specified directory": testExposes({
      script: 'target-dir.js',
      ***REMOVED***ert: compareWithExample('subdir')
    }),
    "and p***REMOVED***ed no arguments": testExposes({
      script: 'all-properties.js',
      ***REMOVED***ert: compareWithExample()
    })
  }
}).export(module);
